## Store: useChatStore

Zustand store that manages conversations, messages, and pagination state for the chat UI.

### Key state

- `conversations`: array of session summaries and, once loaded, messages.
- `meta`: { hasMore, nextCursor, pageSize, totalCount? } from GET `/api/chat/sync`.
- `activeConversationId`: currently selected conversation id.
- `isLoading`: request-in-flight flag; `error`: last error string.

### Core actions

- `loadInitialConversations()`
  - Calls GET `/api/chat/sync?summary_only=true` with default limit=20; sets `conversations` and `meta`.

- `loadMoreConversations()`
  - Uses `meta.nextCursor` to call GET `/api/chat/sync?summary_only=true&cursor_ts=...&cursor_id=...` and appends deduped results; updates `meta`.

- `switchConversation(id)`
  - Selects the conversation and, if messages are missing, triggers `loadConversationMessages(id)`.

- `loadConversationMessages(id)`
  - Calls GET `/api/chat/messages?session_id=...` and merges messages into the matching conversation; updates messageCount, lastMessagePreview, lastMessageTimestamp, updatedAt.

### Notes

- Conversations are sorted by `last_message_timestamp DESC, id DESC` per server; the store maintains that order on merges.
- Summary-only keeps sidebar payloads small; messages are loaded on demand and cached in-state.
# useChatStore

## Purpose / Overview

Manages chat conversations including message history and active conversation.
State is persisted to `localStorage` using Zustand's `persist` middleware.
A hydration flag prevents mismatches during SSR.

## State Shape

| State Variable             | Type                                                                                                            | Description                                                       |
| -------------------------- | --------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `conversations`            | `Conversation[]`                                                                                                | All saved conversations.                                          |
| `currentConversationId`    | `string \| null`                                                                                                | ID of the active conversation.                                    |
| `isLoading`                | `boolean`                                                                                                       | `true` while waiting for an API response.                         |
| `error`                    | `ChatError \| null`                                                                                             | Last request error.                                               |
| `conversationErrorBanners` | `Record<string, { messageId: string; message: string; code?: string; retryAfter?: number; createdAt: string }>` | Ephemeral, session-only per-conversation banners (not persisted). |
| `isHydrated`               | `boolean`                                                                                                       | `true` once state is restored from storage.                       |
| `isSyncing`                | `boolean`                                                                                                       | Indicates a sync request is in progress.                          |
| `lastSyncTime`             | `Date \| null`                                                                                                  | Timestamp of the last successful sync.                            |
| `syncError`                | `string \| null`                                                                                                | Error message from the last sync attempt.                         |

## Actions / Methods

| Action                             | Parameters                                               | Description                                                                       |
| ---------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------- |
| `createConversation`               | `(title?: string)`                                       | Start a new conversation and return its ID.                                       |
| `switchConversation`               | `(id: string)`                                           | Mark a conversation as active.                                                    |
| `sendMessage`                      | `(content: string, model?: string)`                      | Send a user message to the backend.                                               |
| `updateConversationTitle`          | `(id: string, title: string, isAutoGenerated?: boolean)` | Rename a conversation. Enhanced to handle auto-generated vs manual title updates. |
| `deleteConversation`               | `(id: string)`                                           | Remove a conversation and select another if available.                            |
| `clearCurrentMessages`             | `()`                                                     | Remove all messages from the current conversation.                                |
| `clearError`                       | `()`                                                     | Reset the `error` state.                                                          |
| `clearMessageError`                | `(messageId: string)`                                    | Clear the error flag on a specific message.                                       |
| `retryLastMessage`                 | `()`                                                     | Resend the last user message. Dismisses the ephemeral banner before retrying.     |
| `setConversationErrorBanner`       | `(conversationId: string, banner: Banner)`               | Set the session-only banner for a conversation.                                   |
| `clearConversationErrorBanner`     | `(conversationId: string)`                               | Clear the banner for a conversation.                                              |
| `clearAllConversationErrorBanners` | `()`                                                     | Clear all banners (e.g., on sign-in/out).                                         |
| `syncConversations`                | `()`                                                     | Upload all user conversations to the server.                                      |
| `loadUserConversations`            | `(userId: string)`                                       | Merge server conversations into local state.                                      |
| `migrateAnonymousConversations`    | `(userId: string)`                                       | Assign existing local conversations to the signed-in user.                        |
| `filterConversationsByUser`        | `(userId: string \| null)`                               | Display conversations for the given user.                                         |
| `clearAllConversations`            | `()`                                                     | Delete every conversation from local storage.                                     |

## Selectors / Computed State

| Selector                         | Description                              |
| -------------------------------- | ---------------------------------------- |
| `getCurrentConversation()`       | Returns the active conversation object.  |
| `getCurrentMessages()`           | Messages from the active conversation.   |
| `getConversationById(id)`        | Find a conversation by ID.               |
| `getConversationCount()`         | Number of stored conversations.          |
| `getTotalMessages()`             | Total messages across all conversations. |
| `getRecentConversations(limit?)` | Conversations sorted by recent activity. |

## Persistence Behavior

- Uses `persist` with `createJSONStorage` to store conversations in `localStorage`.
- Only `conversations` and `currentConversationId` are persisted.
- Dates are deserialized on rehydrate and `_hasHydrated()` sets `isHydrated`.
- Sync metadata like `lastSyncTime` is kept in memory only.

## SSR Considerations

`useChat` and `useChatStore` avoid returning data until `isHydrated` is `true`
to prevent hydration mismatches when server rendering.

## Wrapper Hooks

`useChat()` wraps the store for backward compatibility. It hides
internal state until hydration completes.

## Developer Tips

- `createLogger('ChatStore')` logs actions when devtools are enabled.
- Store utilities in `storeUtils.ts` provide safe localStorage helpers.
- Use `syncConversations` after sign-in to ensure local changes reach the server.
- **Title Update Optimization**: Auto-generated titles bypass separate API calls and piggyback on message saving for efficiency.
- **Session Title Integration**: Message saving now includes session title updates to reduce race conditions.

## Enhanced Session Title Management

### Auto-Generated Titles

- **Trigger**: When first user message is sent to a "New Chat" conversation
- **Behavior**: Uses enhanced `/api/chat/messages` endpoint with `sessionTitle` parameter
- **Benefits**: Single API call instead of separate session title update
- **Implementation**: `isAutoGenerated: true` flag bypasses `/api/chat/session` endpoint
- **Retry Support**: If the first message fails, a successful retry will rerun this auto-title logic.
- **Retry Support**: If the first message fails, a successful retry will rerun this auto-title logic.

### Error/Retry flow (updated)

- On a local failure, the store marks the failed user message with `error=true`, `error_message`, `retry_available=true`, and sets the session-only banner via `setConversationErrorBanner`.
- On successful retry, error flags are cleared; the per-conversation banner is cleared before retry.
- On manual dismiss or on sending a new message, only the banner is cleared. Message history remains unchanged.
- When messages are loaded from the server (via sync endpoints), `retry_available` may be `false` on prior-session failures (CTA only). Banners are not derived from server data.

### Manual Title Updates

- **Trigger**: User manually edits conversation title in ChatSidebar
- **Behavior**: Uses `/api/chat/session` endpoint for immediate title updates
- **Benefits**: Preserves existing manual editing workflow
- **Implementation**: `isAutoGenerated: false` (default) or omitted

### Code Example

```typescript
// Auto-generated title (optimized flow)
updateConversationTitle(conversationId, autoTitle, true);

// Manual title edit (traditional flow)
updateConversationTitle(conversationId, userEditedTitle); // isAutoGenerated defaults to false
```

### API Integration Flow

1. **Auto-titles**: Included in message payload → single `/api/chat/messages` call
2. **Manual edits**: Separate `/api/chat/session` call for immediate update
3. **Race condition prevention**: Auto-titles only happen during message saving when session exists/is created
