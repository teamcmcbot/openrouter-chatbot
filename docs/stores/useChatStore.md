# useChatStore

## Purpose / Overview

Manages chat conversations including message history and active conversation.
State is persisted to `localStorage` using Zustand's `persist` middleware.
A hydration flag prevents mismatches during SSR.

## State Shape

| State Variable          | Type                | Description                                 |
| ----------------------- | ------------------- | ------------------------------------------- |
| `conversations`         | `Conversation[]`    | All saved conversations.                    |
| `currentConversationId` | `string \| null`    | ID of the active conversation.              |
| `isLoading`             | `boolean`           | `true` while waiting for an API response.   |
| `error`                 | `ChatError \| null` | Last request error.                         |
| `isHydrated`            | `boolean`           | `true` once state is restored from storage. |
| `isSyncing`             | `boolean`           | Indicates a sync request is in progress.    |
| `lastSyncTime`          | `Date \| null`      | Timestamp of the last successful sync.      |
| `syncError`             | `string \| null`    | Error message from the last sync attempt.   |

## Actions / Methods

| Action                          | Parameters                                               | Description                                                                       |
| ------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------- |
| `createConversation`            | `(title?: string)`                                       | Start a new conversation and return its ID.                                       |
| `switchConversation`            | `(id: string)`                                           | Mark a conversation as active.                                                    |
| `sendMessage`                   | `(content: string, model?: string)`                      | Send a user message to the backend.                                               |
| `updateConversationTitle`       | `(id: string, title: string, isAutoGenerated?: boolean)` | Rename a conversation. Enhanced to handle auto-generated vs manual title updates. |
| `deleteConversation`            | `(id: string)`                                           | Remove a conversation and select another if available.                            |
| `clearCurrentMessages`          | `()`                                                     | Remove all messages from the current conversation.                                |
| `clearError`                    | `()`                                                     | Reset the `error` state.                                                          |
| `clearMessageError`             | `(messageId: string)`                                    | Clear the error flag on a specific message.                                       |
| `retryLastMessage`              | `()`                                                     | Resend the last user message.                                                     |
| `syncConversations`             | `()`                                                     | Upload all user conversations to the server.                                      |
| `loadUserConversations`         | `(userId: string)`                                       | Merge server conversations into local state.                                      |
| `migrateAnonymousConversations` | `(userId: string)`                                       | Assign existing local conversations to the signed-in user.                        |
| `filterConversationsByUser`     | `(userId: string \| null)`                               | Display conversations for the given user.                                         |
| `clearAllConversations`         | `()`                                                     | Delete every conversation from local storage.                                     |

## Selectors / Computed State

| Selector                         | Description                              |
| -------------------------------- | ---------------------------------------- |
| `getCurrentConversation()`       | Returns the active conversation object.  |
| `getCurrentMessages()`           | Messages from the active conversation.   |
| `getConversationById(id)`        | Find a conversation by ID.               |
| `getConversationCount()`         | Number of stored conversations.          |
| `getTotalMessages()`             | Total messages across all conversations. |
| `getRecentConversations(limit?)` | Conversations sorted by recent activity. |

## Persistence Behavior

- Uses `persist` with `createJSONStorage` to store conversations in `localStorage`.
- Only `conversations` and `currentConversationId` are persisted.
- Dates are deserialized on rehydrate and `_hasHydrated()` sets `isHydrated`.
- Sync metadata like `lastSyncTime` is kept in memory only.

## SSR Considerations

`useChat` and `useChatStore` avoid returning data until `isHydrated` is `true`
to prevent hydration mismatches when server rendering.

## Wrapper Hooks

`useChat()` wraps the store for backward compatibility. It hides
internal state until hydration completes.

## Developer Tips

- `createLogger('ChatStore')` logs actions when devtools are enabled.
- Store utilities in `storeUtils.ts` provide safe localStorage helpers.
- Use `syncConversations` after sign-in to ensure local changes reach the server.
- **Title Update Optimization**: Auto-generated titles bypass separate API calls and piggyback on message saving for efficiency.
- **Session Title Integration**: Message saving now includes session title updates to reduce race conditions.

## Enhanced Session Title Management

### Auto-Generated Titles

- **Trigger**: When first user message is sent to a "New Chat" conversation
- **Behavior**: Uses enhanced `/api/chat/messages` endpoint with `sessionTitle` parameter
- **Benefits**: Single API call instead of separate session title update
- **Implementation**: `isAutoGenerated: true` flag bypasses `/api/chat/session` endpoint
- **Retry Support**: If the first message fails, a successful retry will rerun this auto-title logic.
- **Retry Support**: If the first message fails, a successful retry will rerun this auto-title logic.

### Error/Retry flow (updated)

- On a local failure, the store marks the failed user message with `error=true`, `error_message`, and `retry_available=true`.
- On successful retry, error flags are cleared and `retry_available` is removed.
- When messages are loaded from the server (via sync endpoints), previously failed user messages are mapped with `retry_available=false` so the UI won’t offer a retry banner for prior-session failures.

### Manual Title Updates

- **Trigger**: User manually edits conversation title in ChatSidebar
- **Behavior**: Uses `/api/chat/session` endpoint for immediate title updates
- **Benefits**: Preserves existing manual editing workflow
- **Implementation**: `isAutoGenerated: false` (default) or omitted

### Code Example

```typescript
// Auto-generated title (optimized flow)
updateConversationTitle(conversationId, autoTitle, true);

// Manual title edit (traditional flow)
updateConversationTitle(conversationId, userEditedTitle); // isAutoGenerated defaults to false
```

### API Integration Flow

1. **Auto-titles**: Included in message payload → single `/api/chat/messages` call
2. **Manual edits**: Separate `/api/chat/session` call for immediate update
3. **Race condition prevention**: Auto-titles only happen during message saving when session exists/is created
